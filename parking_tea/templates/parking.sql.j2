SELECT
  pol.name,
  st_asgeojson(st_transform(st_centroid(pol.way), 4326)),
  st_distance(
      st_transform(ST_GeomFromText('POINT({{ longitude }} {{ latitude }})', 4326), 3857),
      st_transform(st_centroid(pol.way), 3857))
FROM osm_polygon pol
WHERE amenity = 'parking'
      AND {{ area_size }} > st_distance(
          st_transform(ST_GeomFromText('POINT({{ longitude }} {{ latitude }})', 4326), 3857),
          st_transform(st_centroid(pol.way), 3857))
      {% if fee %}
      AND pol.tags->'fee' = 'no'
      {% endif %}
      {% if capacity %}
      AND trunc(pol.way_area / 12) >= {{ capacity }}
{% endif %}

{% if not capacity %}
UNION ALL

SELECT
  p.name,
  st_asgeojson(st_transform(p.way, 4326)),
  st_distance(
      st_transform(ST_GeomFromText('POINT({{ longitude }} {{ latitude }})', 4326), 3857),
      st_transform(p.way, 3857))
FROM osm_point p
WHERE amenity = 'parking'
      AND {{ area_size }} > st_distance(
          st_transform(ST_GeomFromText('POINT({{ longitude }} {{ latitude }})', 4326), 3857),
          st_transform(p.way, 3857))
      {% if fee %}
      AND p.tags->'fee' = 'no'
      {% endif %}
{% endif %}
order by st_distance